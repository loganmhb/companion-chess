// Generated by CoffeeScript 1.10.0
(function() {
  var begin, board, cfg, computerMoveBtn, fenEl, game, makeComputerMove, newgame, pgnEl, pieceBelongsToMovingSide, playerSide, statusEl, updateBoard, updateStatus;

  statusEl = $('#status');

  pgnEl = $('#pgn');

  fenEl = $('#fen');

  computerMoveBtn = $('#move');

  newgame = $('#newgame');

  updateStatus = function() {
    var moveColor, status;
    if (game.turn() === 'w') {
      moveColor = 'White';
    } else {
      moveColor = 'Black';
    }
    if (game.in_checkmate()) {
      status = 'Game over, #{moveColor} is in checkmate.';
    } else if (game.in_draw()) {
      status = 'Game over, drawn position.';
    } else {
      status = moveColor + ' to move.';
      if (game.in_check()) {
        status += ' In check.';
      }
    }
    statusEl.html(status);
    fenEl.html(game.fen());
    console.log(game.pgn());
    return pgnEl.html(game.pgn());
  };

  updateBoard = function() {
    return board.position(game.fen());
  };

  pieceBelongsToMovingSide = function(movingSide, piece) {
    return (movingSide === 'w' && piece.search(/^b/) !== 1) && (movingSide === 'b' && piece.search(/^w/) !== 1);
  };

  cfg = {
    draggable: true,
    position: 'start',
    onDragStart: function(source, piece, position, orientation) {
      console.log("Game turn: " + (game.turn()));
      if (game.game_over() || pieceBelongsToMovingSide(game.turn(), piece)) {
        return false;
      }
    },
    onDrop: function(source, target) {
      var move;
      move = game.move({
        from: source,
        to: target,
        promotion: 'q'
      });
      if (move === null) {
        return 'snapback';
      }
      updateStatus();
      if (game.turn() !== playerSide) {
        return makeComputerMove();
      }
    },
    onSnapEnd: function() {
      return updateBoard();
    }
  };

  game = new Chess();

  board = new ChessBoard('board', cfg);

  makeComputerMove = function() {
    console.log("Making computer move.");
    return engine.makeBestMove(game.fen(), function(move) {
      var result;
      result = game.move(move);
      updateBoard();
      return updateStatus();
    });
  };

  playerSide = 'w';

  begin = function() {
    game.reset();
    board.orientation(playerSide === 'w' ? "white" : "black");
    updateBoard();
    updateStatus();
    if (playerSide === 'b') {
      return makeComputerMove();
    }
  };

  newgame.click(function(event) {
    playerSide = $("#sideSelector").val();
    return begin();
  });

}).call(this);
